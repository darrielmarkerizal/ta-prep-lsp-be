{
  "version": 3,
  "sources": ["../../src/events/bus.ts"],
  "sourcesContent": ["import type { ApiReferenceEvents } from './definitions'\n\ntype Unsubscribe = () => void\n\n/**\n * Helper type for event listeners that makes the payload optional\n * if the event allows undefined, otherwise requires it.\n */\ntype EventListener<E extends keyof ApiReferenceEvents> = undefined extends ApiReferenceEvents[E]\n  ? (payload?: ApiReferenceEvents[E]) => void\n  : (payload: ApiReferenceEvents[E]) => void\n\n/**\n * Helper type for emit parameters that uses rest parameters\n * for a cleaner API surface.\n */\ntype EmitParameters<E extends keyof ApiReferenceEvents> = undefined extends ApiReferenceEvents[E]\n  ? [event: E, payload?: ApiReferenceEvents[E]]\n  : [event: E, payload: ApiReferenceEvents[E]]\n\n/**\n * Type-safe event bus for workspace events\n *\n * - Full type safety for event names and payloads\n * - Debug mode for development\n */\nexport type WorkspaceEventBus = {\n  /**\n   * Subscribe to an event\n   *\n   * @param event - The event name to listen for\n   * @param listener - Callback function that receives the event detail\n   * @returns Unsubscribe function to remove the listener\n   *\n   * @example\n   * const unsubscribe = bus.on('scalar-update-sidebar', (detail) => {\n   *   console.log('Sidebar state:', detail.value)\n   * })\n   *\n   * // Later, clean up\n   * unsubscribe()\n   */\n  on<E extends keyof ApiReferenceEvents>(event: E, listener: EventListener<E>): Unsubscribe\n\n  /**\n   * Remove a specific event listener\n   *\n   * @param event - The event name\n   * @param listener - The listener function to remove\n   *\n   * @example\n   * const handler = (detail) => console.log(detail)\n   * bus.on('scalar-update-sidebar', handler)\n   * bus.off('scalar-update-sidebar', handler)\n   */\n  off<E extends keyof ApiReferenceEvents>(event: E, listener: EventListener<E>): void\n\n  /**\n   * Emit an event with its payload\n   *\n   * @param event - The event name to emit\n   * @param payload - The event detail payload (optional if event allows undefined)\n   *\n   * @example\n   * bus.emit('scalar-update-sidebar', { value: true })\n   */\n  emit<E extends keyof ApiReferenceEvents>(...args: EmitParameters<E>): void\n}\n\n/**\n * Options for creating an event bus\n */\nexport type EventBusOptions = {\n  /**\n   * Enable debug mode to log all events and listener operations\n   * Useful for development and troubleshooting\n   */\n  debug?: boolean\n}\n\n/**\n * Creates a type-safe event bus for workspace events\n *\n * This implementation uses a Map for O(1) lookups and maintains\n * a separate Set for each event type to efficiently manage listeners.\n *\n * Create this once per application instance.\n *\n * @param options - Configuration options\n * @returns A fully type-safe event bus instance\n *\n * @example\n * const bus = createWorkspaceEventBus()\n *\n * // Subscribe to events\n * const unsubscribe = bus.on('scalar-update-sidebar', (detail) => {\n *   console.log('Sidebar:', detail.value)\n * })\n *\n * // Emit events\n * bus.emit('scalar-update-sidebar', { value: true })\n *\n * // Clean up\n * unsubscribe()\n */\nexport const createWorkspaceEventBus = (options: EventBusOptions = {}): WorkspaceEventBus => {\n  const { debug = false } = options\n\n  /**\n   * Map of event names to their listener sets\n   * Using Map for O(1) lookups and Set for O(1) add/remove operations\n   */\n  type ListenerSet = Set<EventListener<keyof ApiReferenceEvents>>\n  const events = new Map<keyof ApiReferenceEvents, ListenerSet>()\n\n  /**\n   * Get or create a listener set for an event\n   */\n  const getListeners = <E extends keyof ApiReferenceEvents>(event: E): ListenerSet => {\n    let listeners = events.get(event)\n    if (!listeners) {\n      listeners = new Set()\n      events.set(event, listeners)\n    }\n    return listeners\n  }\n\n  /**\n   * Log debug information if debug mode is enabled\n   */\n  const log = (message: string, ...args: unknown[]): void => {\n    if (debug) {\n      console.log(`[EventBus] ${message}`, ...args)\n    }\n  }\n\n  const on = <E extends keyof ApiReferenceEvents>(event: E, listener: EventListener<E>): Unsubscribe => {\n    const listeners = getListeners(event)\n    listeners.add(listener as EventListener<keyof ApiReferenceEvents>)\n    log(`Added listener for \"${String(event)}\" (${listeners.size} total)`)\n\n    return () => off(event, listener)\n  }\n\n  const off = <E extends keyof ApiReferenceEvents>(event: E, listener: EventListener<E>): void => {\n    const listeners = events.get(event)\n    if (!listeners) {\n      return\n    }\n\n    listeners.delete(listener as EventListener<keyof ApiReferenceEvents>)\n    log(`Removed listener for \"${String(event)}\" (${listeners.size} remaining)`)\n\n    // Clean up empty listener sets to avoid memory leaks\n    if (listeners.size === 0) {\n      events.delete(event)\n    }\n  }\n\n  const emit = <E extends keyof ApiReferenceEvents>(...args: EmitParameters<E>): void => {\n    const [event, payload] = args\n    const listeners = events.get(event)\n\n    if (!listeners || listeners.size === 0) {\n      log(`No listeners for \"${String(event)}\"`)\n      return\n    }\n\n    log(`Emitting \"${String(event)}\" to ${listeners.size} listener(s)`, payload)\n\n    // Convert to array to avoid issues if listeners modify the set during iteration\n    const listenersArray = Array.from(listeners)\n\n    // Execute all listeners\n    for (const listener of listenersArray) {\n      try {\n        listener(payload)\n      } catch (error) {\n        // Do not let one listener error break other listeners\n        console.error(`[EventBus] Error in listener for \"${String(event)}\":`, error)\n      }\n    }\n  }\n\n  return {\n    on,\n    off,\n    emit,\n  }\n}\n"],
  "mappings": "AAyGO,MAAM,0BAA0B,CAAC,UAA2B,CAAC,MAAyB;AAC3F,QAAM,EAAE,QAAQ,MAAM,IAAI;AAO1B,QAAM,SAAS,oBAAI,IAA2C;AAK9D,QAAM,eAAe,CAAqC,UAA0B;AAClF,QAAI,YAAY,OAAO,IAAI,KAAK;AAChC,QAAI,CAAC,WAAW;AACd,kBAAY,oBAAI,IAAI;AACpB,aAAO,IAAI,OAAO,SAAS;AAAA,IAC7B;AACA,WAAO;AAAA,EACT;AAKA,QAAM,MAAM,CAAC,YAAoB,SAA0B;AACzD,QAAI,OAAO;AACT,cAAQ,IAAI,cAAc,OAAO,IAAI,GAAG,IAAI;AAAA,IAC9C;AAAA,EACF;AAEA,QAAM,KAAK,CAAqC,OAAU,aAA4C;AACpG,UAAM,YAAY,aAAa,KAAK;AACpC,cAAU,IAAI,QAAmD;AACjE,QAAI,uBAAuB,OAAO,KAAK,CAAC,MAAM,UAAU,IAAI,SAAS;AAErE,WAAO,MAAM,IAAI,OAAO,QAAQ;AAAA,EAClC;AAEA,QAAM,MAAM,CAAqC,OAAU,aAAqC;AAC9F,UAAM,YAAY,OAAO,IAAI,KAAK;AAClC,QAAI,CAAC,WAAW;AACd;AAAA,IACF;AAEA,cAAU,OAAO,QAAmD;AACpE,QAAI,yBAAyB,OAAO,KAAK,CAAC,MAAM,UAAU,IAAI,aAAa;AAG3E,QAAI,UAAU,SAAS,GAAG;AACxB,aAAO,OAAO,KAAK;AAAA,IACrB;AAAA,EACF;AAEA,QAAM,OAAO,IAAwC,SAAkC;AACrF,UAAM,CAAC,OAAO,OAAO,IAAI;AACzB,UAAM,YAAY,OAAO,IAAI,KAAK;AAElC,QAAI,CAAC,aAAa,UAAU,SAAS,GAAG;AACtC,UAAI,qBAAqB,OAAO,KAAK,CAAC,GAAG;AACzC;AAAA,IACF;AAEA,QAAI,aAAa,OAAO,KAAK,CAAC,QAAQ,UAAU,IAAI,gBAAgB,OAAO;AAG3E,UAAM,iBAAiB,MAAM,KAAK,SAAS;AAG3C,eAAW,YAAY,gBAAgB;AACrC,UAAI;AACF,iBAAS,OAAO;AAAA,MAClB,SAAS,OAAO;AAEd,gBAAQ,MAAM,qCAAqC,OAAO,KAAK,CAAC,MAAM,KAAK;AAAA,MAC7E;AAAA,IACF;AAAA,EACF;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;",
  "names": []
}
