import {
  xScalarEnvVarSchema,
  xScalarEnvironmentSchema
} from "../schemas/extensions/document/x-scalar-environments.js";
import { coerceValue } from "../schemas/typebox-coerce.js";
const upsertEnvironment = (document, workspace, { environmentName, payload, collectionType, oldEnvironmentName }) => {
  const collection = collectionType === "document" ? document : workspace;
  if (!collection) {
    return;
  }
  if (!collection["x-scalar-environments"]) {
    collection["x-scalar-environments"] = {};
  }
  const isNewEnvironment = !collection["x-scalar-environments"][oldEnvironmentName ?? environmentName];
  const parsed = coerceValue(xScalarEnvironmentSchema, {
    ...collection["x-scalar-environments"][oldEnvironmentName ?? environmentName],
    ...payload
  });
  collection["x-scalar-environments"][environmentName] = parsed;
  if (oldEnvironmentName && oldEnvironmentName !== environmentName) {
    delete collection["x-scalar-environments"][oldEnvironmentName];
    if (workspace["x-scalar-active-environment"] === oldEnvironmentName) {
      workspace["x-scalar-active-environment"] = environmentName;
    }
  }
  if (isNewEnvironment) {
    workspace["x-scalar-active-environment"] = environmentName;
  }
  return parsed;
};
const upsertEnvironmentVariable = (collection, { environmentName, variable, index }) => {
  if (!collection?.["x-scalar-environments"]?.[environmentName]) {
    console.error("Environment not found", environmentName);
    return;
  }
  const parsed = coerceValue(xScalarEnvVarSchema, variable);
  if (index !== void 0) {
    if (parsed.name === "") {
      collection["x-scalar-environments"][environmentName].variables.splice(index, 1);
      return;
    }
    collection["x-scalar-environments"][environmentName].variables[index] = parsed;
  } else {
    collection["x-scalar-environments"][environmentName].variables.push(parsed);
  }
  return parsed;
};
export {
  upsertEnvironment,
  upsertEnvironmentVariable
};
//# sourceMappingURL=environment.js.map
