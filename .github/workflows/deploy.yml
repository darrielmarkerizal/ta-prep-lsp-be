name: Deploy to VPS (Laravel)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-vps-laravel-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: production

    steps:
      - name: Checkout (metadata only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        env:
          SSH_HOST:   ${{ secrets.SSH_HOST }}
          SSH_USER:   ${{ secrets.SSH_USER }}
          SSH_KEY:    ${{ secrets.SSH_KEY }}
          APP_DIR:    ${{ secrets.APP_DIR }}
        run: |
          set -euo pipefail
          missing=0
          for v in SSH_HOST SSH_USER SSH_KEY APP_DIR; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing secret: $v"
              missing=1
            fi
          done
          exit $missing

      - name: Deployment context
        run: |
          echo "Repo : ${{ github.repository }}"
          echo "Ref  : ${{ github.ref }}"
          echo "SHA  : ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host:     ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key:      ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 20m
          script: |
            set -euo pipefail
            echo ">>> Host check"
            uname -a || true
            whoami || true
            date || true

            echo ">>> Go to app dir"
            cd "${{ secrets.APP_DIR }}"

            echo ">>> Ensure deploy.sh executable"
            chmod +x deploy.sh

            echo ">>> Run deploy.sh"
            ./deploy.sh
