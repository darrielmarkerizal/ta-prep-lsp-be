name: Deploy Laravel to VPS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-vps-laravel-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: production

    steps:
      - name: Checkout repository metadata
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY:  ${{ secrets.SSH_KEY }}
          APP_DIR:  ${{ secrets.APP_DIR }}
        run: |
          set -euo pipefail
          echo "::group::Validating environment variables"
          missing=0
          for v in SSH_HOST SSH_USER SSH_KEY APP_DIR; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing required secret: $v"
              missing=1
            else
              echo "::notice::Validated $v"
            fi
          done

          if [[ -n "${SSH_HOST:-}" ]]; then
            if ! [[ "$SSH_HOST" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ || "$SSH_HOST" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ || "$SSH_HOST" =~ ^[a-zA-Z0-9.-]+$ ]]; then
              echo "::error::Invalid SSH_HOST format: $SSH_HOST"
              missing=1
            fi
          fi

          if [[ -n "${SSH_KEY:-}" ]]; then
            first_line="$(printf '%s' "$SSH_KEY" | head -n1 || true)"
            if ! [[ "$first_line" =~ ^-----BEGIN\ .*PRIVATE\ KEY-----$ ]]; then
              echo "::error::SSH_KEY is not in a valid OpenSSH/PEM format (first line: $first_line)"
              missing=1
            fi
          fi

          if [[ -n "${APP_DIR:-}" ]]; then
            if [[ "$APP_DIR" != /* ]]; then
              echo "::error::APP_DIR must be an absolute path, received: $APP_DIR"
              missing=1
            fi
          fi
          echo "::endgroup::"
          exit $missing

      - name: Print deployment context
        run: |
          echo "::group::Deployment context"
          echo "Repository  : ${{ github.repository }}"
          echo "Branch      : ${{ github.ref }}"
          echo "Commit SHA  : ${{ github.sha }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "::endgroup::"

      - name: Execute remote deployment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host:     ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key:      ${{ secrets.SSH_KEY }}
          port:     22
          script_stop: true
          command_timeout: 20m
          script: |
            set -euo pipefail

            echo "::group::System information"
            echo "User    : $(whoami || true)"
            echo "Kernel  : $(uname -a || true)"
            echo "Date    : $(date || true)"
            echo "App Dir : '${{ secrets.APP_DIR }}'"
            echo "::endgroup::"

            echo "::group::Verifying application directory"
            if [ ! -d "${{ secrets.APP_DIR }}" ]; then
              echo "::error::Application directory not found: '${{ secrets.APP_DIR }}'"
              exit 71
            fi
            cd "${{ secrets.APP_DIR }}"
            if [ ! -w "." ]; then
              echo "::error::Insufficient write permissions in application directory."
              exit 72
            fi
            echo "::notice::Application directory verified."
            echo "::endgroup::"

            echo "::group::Checking Git repository"
            if ! command -v git >/dev/null 2>&1; then
              echo "::error::Git is not installed on the server."
              exit 73
            fi
            git rev-parse --is-inside-work-tree >/dev/null 2>&1 || { echo "::error::Current directory is not a Git repository."; exit 74; }
            echo "::notice::Git remote: $(git remote -v | head -n1 || true)"
            echo "::endgroup::"

            echo "::group::Verifying deployment script"
            if [ ! -f "./deploy.sh" ]; then
              echo "::error::The file 'deploy.sh' was not found in the application directory."
              exit 75
            fi
            chmod +x ./deploy.sh
            echo "::notice::Deployment script is executable."
            echo "::endgroup::"

            echo "::group::Checking runtime dependencies"
            set +e
            echo "PATH: $PATH"
            which php || true
            php -v | head -n 2
            php_ec=$?
            echo "php -v exit code: ${php_ec}"

            which composer || true
            composer --version
            comp_ec=$?
            echo "composer --version exit code: ${comp_ec}"
            if [ ${comp_ec} -ne 0 ]; then
              echo "::warning::Composer not available or returned a non-zero exit code. The deploy script must handle dependency installation."
            fi
            set -e
            echo "::endgroup::"

            echo "::group::Pulling latest code"
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            echo "::notice::Code updated to latest version."
            echo "::endgroup::"

            echo "::group::Installing dependencies (with dev for testing)"
            if ! composer install --no-interaction --prefer-dist --optimize-autoloader; then
              echo "::error::Composer install failed"
              exit 76
            fi
            echo "::notice::Dependencies installed successfully."
            echo "::endgroup::"

            echo "::group::Creating database backup"
            BACKUP_DIR="storage/app/backups"
            mkdir -p "$BACKUP_DIR"
            BACKUP_FILE="$BACKUP_DIR/db-backup-$(date +%Y%m%d-%H%M%S).sql"
            set +e  # Temporarily disable exit on error
            php artisan backup:run --only-db > /dev/null 2>&1
            backup_exit_code=$?
            set -e  # Re-enable exit on error
            if [ $backup_exit_code -eq 0 ]; then
              echo "::notice::Database backup created successfully"
            else
              echo "::warning::Backup command not available (install spatie/laravel-backup for automatic backups)"
            fi
            echo "::endgroup::"

            echo "::group::Running database migrations"
            if ! php artisan migrate --force --no-interaction; then
              echo "::error::Database migration failed"
              exit 77
            fi
            echo "::notice::Database migrations completed successfully."
            echo "::endgroup::"

            echo "::group::Optimizing Laravel caches"
            # Clear old caches
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan cache:clear || true
            
            # Warm up new caches for production
            php artisan config:cache || echo "::warning::Config cache failed"
            php artisan route:cache || echo "::warning::Route cache failed"
            php artisan view:cache || echo "::warning::View cache failed"
            php artisan event:cache || echo "::warning::Event cache failed"
            
            echo "::notice::Laravel cache optimization completed."
            echo "::endgroup::"

            echo "::group::Optimizing for production (removing dev dependencies)"
            if ! composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev; then
              echo "::error::Composer install (production) failed"
              exit 79
            fi
            # Optimize composer autoloader
            composer dump-autoload --optimize --classmap-authoritative || true
            echo "::notice::Production dependencies optimized."
            echo "::endgroup::"

            echo "::group::Executing deploy.sh"
            set +e
            ./deploy.sh
            code=$?
            set -e
            if [ $code -ne 0 ]; then
              echo "::error::Deployment script failed with exit code $code"
              if [ -f storage/logs/laravel.log ]; then
                echo "::group::Last 100 lines from laravel.log"
                tail -n 100 storage/logs/laravel.log || true
                echo "::endgroup::"
              fi
              exit $code
            fi
            echo "::notice::Deployment script completed successfully."
            echo "::endgroup::"

            echo "::group::Running post-deployment health checks"
            # Wait for application to stabilize
            sleep 3
            
            # Check if artisan is working
            if ! php artisan --version > /dev/null 2>&1; then
              echo "::error::Laravel artisan not responding after deployment"
              exit 80
            fi
            echo "::notice::✓ Artisan check passed"
            
            # Check database connection
            if ! php artisan db:show > /dev/null 2>&1; then
              echo "::error::Database connection failed after deployment"
              exit 81
            fi
            echo "::notice::✓ Database connection check passed"
            
            # Check if cache is working
            if ! php artisan cache:clear > /dev/null 2>&1; then
              echo "::warning::Cache system may have issues"
            else
              echo "::notice::✓ Cache system check passed"
            fi
            
            # Optional: HTTP health check if web server is running
            if command -v curl > /dev/null 2>&1; then
              if curl -f -s -o /dev/null --max-time 5 http://localhost/api/health 2>/dev/null || \
                 curl -f -s -o /dev/null --max-time 5 http://localhost/up 2>/dev/null; then
                echo "::notice::✓ HTTP health check passed"
              else
                echo "::warning::HTTP health check not available (server may not be running on localhost)"
              fi
            fi
            
            echo "::notice::All health checks completed successfully ✓"
            echo "::endgroup::"