workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_TAG
      when: always
  auto_cancel_pending_pipelines: true

stages:
  - test
  - deploy

test:
  stage: test
  image: php:8.4-cli
  services:
    - postgres:15-alpine
  cache:
    key: composer-vendor
    paths:
      - vendor/
    policy: pull-push
  before_script:
    # Install System Dependencies
    - apt-get update -qq
    - apt-get install -y -qq git unzip libzip-dev libpq-dev libpng-dev libjpeg-dev libfreetype6-dev libicu-dev
    
    # Install PHP Extensions
    - docker-php-ext-configure gd --with-freetype --with-jpeg
    - docker-php-ext-install -j$(nproc) pdo pdo_pgsql pgsql zip gd bcmath exif intl
    
    # Install Composer
    - php -r "copy('https://getcomposer.org/installer','composer-setup.php');"
    - php composer-setup.php --quiet
    - mv composer.phar /usr/local/bin/composer
    
    # Install Project Dependencies
    - composer install --prefer-dist --no-progress --optimize-autoloader --no-interaction
    
    # Setup Laravel
    - cp .env.example .env
    - php artisan key:generate
    - php artisan config:clear
    - php artisan cache:clear
  script:
    - php artisan migrate --force
    - php artisan test --parallel
  artifacts:
    when: always
    expire_in: 1d
    paths:
      - tests/reports/
  only:
    - main
    - tags

deploy:production:
  stage: deploy
  resource_group: production
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync git
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$DEPLOY_SERVER" >> ~/.ssh/known_hosts
  script:
    - chmod +x .gitlab/scripts/deploy.sh
    - .gitlab/scripts/deploy.sh
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_COMMIT_TAG
      when: manual
  environment:
    name: production
    url: https://your-api-domain.com
